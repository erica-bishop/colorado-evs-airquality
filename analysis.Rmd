---
title: "EVs and local air quality"
author: "Erica Bishop"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(here)
library(janitor)
library(lubridate)
#library(datapasta)
library(zoo)
library(ggpubr)
library(gridExtra)
library(gt)
library(modelr)
library(feasts)
library(tsibble)

```


```{r}
#set up data directory
datadir <- ("/Users/ericabishop/Documents/MEDS-fall-classwork/EDS222-stats/final_project/data")


#read in EV data and format dates
co_evs <- read_csv(file.path(datadir, "co_ev_registrations_public.csv")) |> 
  janitor::clean_names() 

#format dates
co_evs <- co_evs |> 
  mutate(registration_valid_date = lubridate::mdy(registration_valid_date),
         registration_expiration_date = lubridate::mdy(registration_expiration_date))

```
EV data: 
- zip codes are a hot mess (multiple different formats / lengths?)
- over 1300 unique zips (should be no more than 500 or so)
- date range: January 2010 - July 2022

Air Quality data from the EPA's Air Data: https://www.epa.gov/outdoor-air-quality-data
- from https://aqs.epa.gov/aqsweb/airdata/download_files.html
- Daily AQI, Daily Ozone, and Annual AQI data by county


```{r}

#read in raw daily AQI data

daily_aqi_raw_10 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2010.csv"))
daily_aqi_raw_11 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2011.csv"))
daily_aqi_raw_12 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2012.csv"))
daily_aqi_raw_13 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2013.csv"))
daily_aqi_raw_14 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2014.csv"))
daily_aqi_raw_15 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2015.csv"))
daily_aqi_raw_16 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2016.csv"))
daily_aqi_raw_17 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2017.csv"))
daily_aqi_raw_18 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2018.csv"))
daily_aqi_raw_19 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2019.csv"))
daily_aqi_raw_20 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2020.csv"))
daily_aqi_raw_21 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2021.csv"))
daily_aqi_raw_22 <- read_csv(file.path(datadir, "daily_county_aqi", "daily_aqi_by_county_2022.csv"))

```

```{r}
#Function to filter dfs to just counties in Colorado
filter_CO <- function(df) {
  df_filtered <- df |> 
    filter(`State Name` == "Colorado") |> 
    clean_names()
  return(df_filtered)
}

#run function on data frames:
daqi_10_CO <- filter_CO(daily_aqi_raw_10)
daqi_11_CO <- filter_CO(daily_aqi_raw_11)
daqi_12_CO <- filter_CO(daily_aqi_raw_12)
daqi_13_CO <- filter_CO(daily_aqi_raw_13)
daqi_14_CO <- filter_CO(daily_aqi_raw_14)
daqi_15_CO <- filter_CO(daily_aqi_raw_15)
daqi_16_CO <- filter_CO(daily_aqi_raw_16)
daqi_17_CO <- filter_CO(daily_aqi_raw_17)
daqi_18_CO <- filter_CO(daily_aqi_raw_18)
daqi_19_CO <- filter_CO(daily_aqi_raw_19)
daqi_20_CO <- filter_CO(daily_aqi_raw_20)
daqi_21_CO <- filter_CO(daily_aqi_raw_21)
daqi_22_CO <- filter_CO(daily_aqi_raw_22)
  
#join using rbind
daqi_CO <- rbind(daqi_10_CO, daqi_11_CO, daqi_12_CO, daqi_13_CO, daqi_14_CO, daqi_15_CO, daqi_16_CO, daqi_17_CO, daqi_18_CO, daqi_19_CO, daqi_20_CO, daqi_21_CO, daqi_22_CO)

daqi_CO <- daqi_CO |> 
  rename(date_local = date) #renaming in case joining to ozone data

```

```{r}

#read in daily ozone data
daily_ozone_2010 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2010.csv"))
daily_ozone_2011 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2011.csv"))
daily_ozone_2012 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2012.csv"))
daily_ozone_2013 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2013.csv"))
daily_ozone_2014 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2014.csv"))
daily_ozone_2015 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2015.csv"))
daily_ozone_2016 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2016.csv"))
daily_ozone_2017 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2017.csv"))
daily_ozone_2018 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2018.csv"))
daily_ozone_2019 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2019.csv"))
daily_ozone_2020 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2020.csv"))
daily_ozone_2021 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2021.csv"))
daily_ozone_2022 <- read_csv(file.path(datadir, "daily_summary_ozone", "daily_44201_2022.csv"))

#filter to just CO
dozo_10_CO <- filter_CO(daily_ozone_2010)
dozo_11_CO <- filter_CO(daily_ozone_2011)
dozo_12_CO <- filter_CO(daily_ozone_2012)
dozo_13_CO <- filter_CO(daily_ozone_2013)
dozo_14_CO <- filter_CO(daily_ozone_2014)
dozo_15_CO <- filter_CO(daily_ozone_2015)
dozo_16_CO <- filter_CO(daily_ozone_2016)
dozo_17_CO <- filter_CO(daily_ozone_2017)
dozo_18_CO <- filter_CO(daily_ozone_2018)
dozo_19_CO <- filter_CO(daily_ozone_2019)
dozo_20_CO <- filter_CO(daily_ozone_2020)
dozo_21_CO <- filter_CO(daily_ozone_2021)
dozo_22_CO <- filter_CO(daily_ozone_2022)

#combine into one df with rbind
dozo_CO <- rbind(dozo_10_CO, dozo_11_CO, dozo_12_CO, dozo_13_CO, dozo_14_CO, dozo_15_CO, dozo_16_CO, dozo_17_CO, dozo_18_CO, dozo_19_CO, dozo_20_CO, dozo_21_CO)

```

```{r}

#read in county data, drop state column
co_counties <- read_csv(file.path(datadir, "CO_counties.csv")) |> 
  clean_names() |> 
  select("county", "zip_code")

#attach county names associated with zip code to co_evs
co_evs_counties <- left_join(co_evs, co_counties, by = "zip_code")

#rename date column to join
co_evs_counties <- co_evs_counties |> 
  rename(date_local = registration_valid_date)

#join ev and ozone data
co_evs_ozone <- full_join(dozo_CO, co_evs_counties, by = "date_local")
#DON"T USE THAT DF ITS GARBAGE


```


Selecting variables of interest and joining by county (rather than zip codes becasue those are a bit of a mess)

```{r}
#manipulate variables of interest into one DF - BY COUNTY

#select columns of interest from EVs into new DF
evs_clean <- co_evs_counties |> 
  select("county", "date_local", "zip_code") |> 
  mutate(my_date = as.yearmon(date_local))
  
#just using ozone data for now
#select columns of interest from ozone into new DF
ozone_clean <- dozo_CO |> 
  select("date_local", "units_of_measure", "parameter_name", "aqi", "county_name", "local_site_name", "x1st_max_value", "x1st_max_hour", "arithmetic_mean") |> 
  mutate(my_date = as.yearmon(date_local))

```

Run some summary statistics to get an idea of what each variable of interest looks like: 
```{r}

evs_summary <- evs_clean |> 
  group_by(my_date) |> 
  summarize(ev_reg_count = n())


ozone_summary <- ozone_clean |> 
  group_by(my_date) |> 
  summarize(monthly_ozone_avg_ppm = mean(arithmetic_mean))

#combine summary tables and include cumulative registration

my_summary <- left_join(evs_summary, ozone_summary, by  = "my_date") |> 
  mutate(cum_evreg_since2010 = cumsum(ev_reg_count))

```
Data exploration:

```{r}
ev_plot <- ggplot(data = my_summary,
       aes(x = my_date,
           y = cum_evreg_since2010)) +
  geom_line()

oz_plot <- ggplot(data = my_summary,
       aes(x = my_date,
           y = monthly_ozone_avg_ppm)) +
  geom_line()



# ggplot(data = my_summary) +
#   geom_line(aes(x = my_date,
#                 y = cum_evreg_since2010)) +
#   geom_point(aes(x = my_date,
#                  y = monthly_ozone_avg_ppm))

# grid.arrange(ev_plot + oz_plot, ncol = 2)

ev_plot
oz_plot

```

### Part 1: Look for a model - is there a relationship between any of the variables?

- find correlation
- find covariance
- scatter plot

```{r}
#investigate correlation
cor(my_summary$cum_evreg_since2010, my_summary$monthly_ozone_avg_ppm, use = "complete.obs") #ignore NAs with complete obs
#ver low positive correlation! But push onwards

#try correlating with monthly EV regs not cumulative
cor(my_summary$ev_reg_count, my_summary$monthly_ozone_avg_ppm, use = "complete.obs")
#ver small negative correlation

```

Maybe there is a long-term trend in the time-series data of the ozone data - try running a classical decomposition to see if there's a long-term trend

To recover seasonality separately from the long run trend, we will use a classical decomposition. That is, we wish to decompose total deaths $D_t$ into a trend component $T_t$, a seasonal component $S_t$, and a random component $R_t$. We will assume an additive model describes our data, as we don't see evidence in the above plot that the magnitude of seasonality is changing over time:

$$D_t = S_t + T_t + R_t$$

```{r}
# ozone_ts <- dozo_CO |> 
#   select("x1st_max_value", "date_local") |> 
#   as_tsibble(index = date_local, key = )

ozone_ts <- my_summary |> 
  select(my_date, monthly_ozone_avg_ppm) |> 
  as_tsibble(index = yearmonth(my_date))

ozone_ts <- my_summary |> 
  mutate(my_date = yearmonth(my_date)) |> 
  as_tsibble(my_summary)

# esales <- arrow::read_feather("data/esales.feather")
# esales %>%
#   dplyr::select(date, sales_GWh = value) -> esales_tbl
# esales_tbl %>% as_tsibble(index = date) -> elsales_tbl_ts


decomp <- as_tsibble(ozone_ts) |> 
  model(
    classical_decomposition(value, type = "additive")
  ) |> 
  components() |> 
  autoplot() +
  labs(title = "Classical additive decomposition of monthly ozone")

decomp




```




Run a simple linear regression model: 
$$\text{monthly_ozone_avg_ppm} = \beta_0 + \beta_1 \text{cum_evreg_since2010} + \epsilon$$


```{r}
#regress ozone days on ev registration


#plot the model





```


###

IF there's nothing significant, try looking at the number of ozone action alert days to see if there's a correlation:
https://docs.google.com/spreadsheets/d/1BHUei0iDaE2EvSIrD4KAN9xy9mQQWhLDAgZtA1iFSl4/edit#gid=1498430605 


### Part 2: Test Hypothesis

Null Hypothesis: beta_1 (slope) = 0 (no relationship between ozone and # of EVs)
Alternate Hypothesis: beta_1 != 0 (or is negative?)

```{r}




```















